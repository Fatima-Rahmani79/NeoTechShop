<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v27.1.0/dist/font-face.css"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"
    />

    <link rel="stylesheet" href="assets/css/main.css" />

    <title>NeoTechShop|Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</title>
  </head>

  <body class="checkout-page">
    <!-- list of cart summery -->
    <section class="product-briefe">
      <h3>ğŸ›’ Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´Ø§Øª Ø´Ù…Ø§</h3>
      <div id="cartItemsContainer"></div>
      <div class="cart-summary">
        <strong>Ø¬Ù…Ø¹ Ú©Ù„: <span id="cartTotal">0</span> Ø§ÙØºØ§Ù†ÛŒ</strong>
      </div>
    </section>

  
    <section class="checkout-user-info">
      <h3>Ù…Ø´Ø®ØµØ§Øª:</h3>
      <p>Ù…Ø´ØªØ±ÛŒ Ø¹Ø²ÛŒØ²ØŒ Ù„Ø·ÙØ§ Ù…Ø´Ø®ØµØ§Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø§ Ø¯Ù‚Øª ÙˆØ§Ø±Ø¯ Ù†Ù…Ø§ÛŒÛŒØ¯.</p>
      <form id="checkoutForm" novalidate>
        <label for="name">Ù†Ø§Ù…:</label>
        <input type="text" id="name" name="name" />

        <label for="phone">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³:</label>
        <input type="tel" id="phone" name="phone" />

        <label for="email">Ø§ÛŒÙ…ÛŒÙ„:</label>
        <input type="email" id="email" name="email" />

        <label for="address">Ø¢Ø¯Ø±Ø³:</label>
        <input type="text" id="address" name="address" />

        <button type="submit" class="btn primary">Ø«Ø¨Øª Ùˆ Ø§Ø¯Ø§Ù…Ù‡</button>
      </form>
    </section>

    <!-- ğŸ’³ Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª -->
    <section class="payment-method">
      <h3>Ù†Ø­ÙˆÙ‡ Ù¾Ø±Ø¯Ø§Ø®Øª:</h3>
      <label class="payment-option">
        <input type="radio" name="payment" value="online" id="online" /> Ù¾Ø±Ø¯Ø§Ø®Øª
        Ø¢Ù†Ù„Ø§ÛŒÙ†
      </label>
      <label class="payment-option">
        <input type="radio" name="payment" value="cash" id="cash" /> Ù¾Ø±Ø¯Ø§Ø®Øª
        Ù‡Ù†Ú¯Ø§Ù… ØªØ­ÙˆÛŒÙ„
      </label>
      <button id="placeOrderBtn" class="btn primary">Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</button>
    </section>

    <!-- ğŸ’° Ù…ÙˆØ¯Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¢Ù†Ù„Ø§ÛŒÙ† -->
    <div
      id="paymentModal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="pmTitle"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <button class="modal-close" id="closeModal" aria-label="Ø¨Ø³ØªÙ†">
          &times;
        </button>
        <h2 id="pmTitle">Ù¾Ø±Ø¯Ø§Ø®Øª Ø¢Ù†Ù„Ø§ÛŒÙ†</h2>

        <form id="paymentForm" class="product-form" novalidate>
          <div class="price-row">
            <span class="label">Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª</span>
            <strong id="amountLabel"></strong>
          </div>

          <div class="field">
            <label for="cardName">Ù†Ø§Ù… ØµØ§Ø­Ø¨ Ú©Ø§Ø±Øª</label>
            <input
              type="text"
              id="cardName"
              name="cardName"
              placeholder="Ù†Ø§Ù… Ùˆ ØªØ®Ù„Øµ"
              autocomplete="cc-name"
              required
            />
            <div class="err" id="errName"></div>
          </div>

          <div class="field">
            <label for="cardNumber">Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª</label>
            <input
              id="cardNumber"
              name="cardNumber"
              inputmode="numeric"
              pattern="[0-9 ]*"
              maxlength="19"
              placeholder="4444 3333 2222 1111"
              autocomplete="cc-number"
              required
            />
            <div class="err" id="errNumber"></div>
          </div>

          <div class="row">
            <div class="field small">
              <label for="expDate">ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§ (MM/YY)</label>
              <input
                id="expDate"
                name="expDate"
                inputmode="numeric"
                placeholder="MM/YY"
                maxlength="5"
                autocomplete="cc-exp"
                required
              />
              <div class="err" id="errExp"></div>
            </div>

            <div class="field small">
              <label for="cvv">CVV2</label>
              <input
                id="cvv"
                name="cvv"
                inputmode="numeric"
                placeholder="3 Ø±Ù‚Ù…ÛŒ"
                maxlength="4"
                autocomplete="cc-csc"
                required
              />
              <div class="err" id="errCvv"></div>
            </div>
          </div>

          <div class="actions">
            <button type="submit" class="btn primary">
              Ù¾Ø±Ø¯Ø§Ø®Øª Ùˆ Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´
            </button>
            <button type="button" class="btn ghost" id="cancelBtn">
              Ø§Ù†ØµØ±Ø§Ù
            </button>
          </div>

          <div
            id="formMessage"
            class="form-message"
            role="status"
            aria-live="polite"
          ></div>
        </form>
      </div>
    </div>

    <script src="assets/js/cart.js"></script>
    <script src="assets/js/script.js"></script>

    <script>
      // ---------------------------
      // ğŸ›’ Û±. Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯
      // ---------------------------
      document.addEventListener("DOMContentLoaded", () => {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const container = document.getElementById("cartItemsContainer");
        const totalEl = document.getElementById("cartTotal");

        if (cart.length === 0) {
          alert("Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª!");
          window.location.href = "cart-page.html";
          return;
        }

        // Ù†Ù…Ø§ÛŒØ´ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯
        container.innerHTML = cart
          .map((item) => {
            const subtotal = item.price * item.quantity;
            return `
      <div class="checkout-item">
        <img src="${item.image}" alt="${item.name}" class="checkout-item-img" />
        <div class="checkout-item-info">
          <h4>${item.name}</h4>
          <div class="checkout-item-details">
            <p>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯: ${item.price.toLocaleString()} Ø§ÙØºØ§Ù†ÛŒ</p>
            <p>ØªØ¹Ø¯Ø§Ø¯: ${item.quantity}</p>
            <p>Ø¬Ù…Ø¹: ${subtotal.toLocaleString()} Ø§ÙØºØ§Ù†ÛŒ</p>
          </div>
        </div>
      </div>
    `;
          })
          .join("");

        const total = cart.reduce(
          (sum, item) => sum + item.price * item.quantity,
          0
        );
        totalEl.textContent = total.toLocaleString();
      });

      // ---------------------------
      // ğŸ‘¤ Û². Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ÙØ±Ù… Ù…Ø´Ø®ØµØ§Øª Ú©Ø§Ø±Ø¨Ø±
      // ---------------------------
      const checkoutForm = document.getElementById("checkoutForm");

      checkoutForm.addEventListener("submit", (e) => {
        e.preventDefault();
        clearErrors();

        const user = getUserFormValues();
        let valid = validateUserInfo(user);

        if (valid) {
          alert("Ù…Ø´Ø®ØµØ§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯ âœ…");
        }
      });

      function getUserFormValues() {
        return {
          name: document.getElementById("name").value.trim(),
          phone: document.getElementById("phone").value.trim(),
          email: document.getElementById("email").value.trim(),
          address: document.getElementById("address").value.trim(),
        };
      }

      function clearErrors() {
        document.querySelectorAll(".error-msg").forEach((el) => el.remove());
        document
          .querySelectorAll(".invalid")
          .forEach((el) => el.classList.remove("invalid"));
      }

      function showError(input, msg) {
        const err = document.createElement("div");
        err.className = "error-msg";
        err.textContent = msg;
        input.classList.add("invalid");
        input.insertAdjacentElement("afterend", err);
      }

      function validateUserInfo({ name, phone, email, address }) {
        let ok = true;

        if (!name) {
          showError(document.getElementById("name"), "Ù†Ø§Ù… Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.");
          ok = false;
        }
        if (!phone) {
          showError(document.getElementById("phone"), "Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.");
          ok = false;
        } else if (!/^(\+93|0)?7\d{8}$/.test(phone)) {
          showError(document.getElementById("phone"), "Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.");
          ok = false;
        }

        if (!email) {
          showError(document.getElementById("email"), "Ø§ÛŒÙ…ÛŒÙ„ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.");
          ok = false;
        } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          showError(document.getElementById("email"), "Ø§ÛŒÙ…ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.");
          ok = false;
        }

        if (address.length < 5) {
          showError(
            document.getElementById("address"),
            "Ø¢Ø¯Ø±Ø³ Ø­Ø¯Ø§Ù‚Ù„ Ø¨Ø§ÛŒØ¯ Ûµ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯."
          );
          ok = false;
        }

        return ok;
      }

      // ---------------------------
      // ğŸ’³ Û³. Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÙˆØ¯Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¢Ù†Ù„Ø§ÛŒÙ†
      // ---------------------------
      const modal = document.getElementById("paymentModal");
      const closeModalBtn = document.getElementById("closeModal");
      const cancelBtn = document.getElementById("cancelBtn");
      const paymentForm = document.getElementById("paymentForm");
      const formMessage = document.getElementById("formMessage");

      function showModal() {
        modal.style.display = "flex";
        modal.setAttribute("aria-hidden", "false");
      }

      function hideModal() {
        modal.style.display = "none";
        modal.setAttribute("aria-hidden", "true");
        clearFormErrors();
      }

      function clearFormErrors() {
        formMessage.textContent = "";
        document
          .querySelectorAll(".err")
          .forEach((el) => (el.textContent = ""));
      }

      modal.addEventListener("click", (e) => {
        const dialog = modal.querySelector(".modal-dialog");
        if (!dialog.contains(e.target)) hideModal();
      });
      closeModalBtn.addEventListener("click", hideModal);
      cancelBtn.addEventListener("click", hideModal);
      document.addEventListener(
        "keydown",
        (e) => e.key === "Escape" && hideModal()
      );

      // ---------------------------
      // ğŸ’³ Û´. Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Øª Ø¨Ø§Ù†Ú©ÛŒ
      // ---------------------------
      const fields = {
        name: document.getElementById("cardName"),
        number: document.getElementById("cardNumber"),
        exp: document.getElementById("expDate"),
        cvv: document.getElementById("cvv"),
        errName: document.getElementById("errName"),
        errNumber: document.getElementById("errNumber"),
        errExp: document.getElementById("errExp"),
        errCvv: document.getElementById("errCvv"),
      };

      fields.number.addEventListener("input", (e) => {
        let val = e.target.value.replace(/\D/g, "").slice(0, 16);
        e.target.value = val.replace(/(\d{4})(?=\d)/g, "$1 ").trim();
      });
      fields.exp.addEventListener("input", (e) => {
        let v = e.target.value.replace(/\D/g, "").slice(0, 4);
        e.target.value = v.length > 2 ? v.slice(0, 2) + "/" + v.slice(2) : v;
      });
      fields.cvv.addEventListener("input", (e) => {
        e.target.value = e.target.value.replace(/\D/g, "").slice(0, 4);
      });

      function luhnCheck(num) {
        return (
          [...num].reverse().reduce((sum, n, i) => {
            n = +n;
            if (i % 2) n = n * 2 > 9 ? n * 2 - 9 : n * 2;
            return sum + n;
          }, 0) %
            10 ===
          0
        );
      }

      function validateExpiry(mmYY) {
        if (!/^\d{2}\/\d{2}$/.test(mmYY)) return false;
        const [mm, yy] = mmYY.split("/").map(Number);
        const now = new Date();
        const thisYear = now.getFullYear() % 100;
        const thisMonth = now.getMonth() + 1;
        return (
          mm >= 1 &&
          mm <= 12 &&
          (yy > thisYear || (yy === thisYear && mm >= thisMonth))
        );
      }

      function validateCardForm() {
        clearFormErrors();
        let ok = true;
        const cardNum = fields.number.value.replace(/\s/g, "");
        if (fields.name.value.trim().length < 3) {
          fields.errName.textContent = "Ù†Ø§Ù… Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª";
          ok = false;
        }
        if (!/^\d{13,16}$/.test(cardNum) || !luhnCheck(cardNum)) {
          fields.errNumber.textContent = "Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª";
          ok = false;
        }
        if (!validateExpiry(fields.exp.value)) {
          fields.errExp.textContent = "ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª";
          ok = false;
        }
        if (!/^\d{3,4}$/.test(fields.cvv.value)) {
          fields.errCvv.textContent = "CVV Ø¨Ø§ÛŒØ¯ Û³ ÛŒØ§ Û´ Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯";
          ok = false;
        }
        return ok;
      }

      // ---------------------------
      // ğŸ’° Ûµ. Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù… Ù¾Ø±Ø¯Ø§Ø®Øª
      // ---------------------------
      paymentForm.addEventListener("submit", (e) => {
        e.preventDefault();
        formMessage.textContent = "";

        if (!validateCardForm()) {
          formMessage.textContent = "Ù„Ø·ÙØ§Ù‹ Ø®Ø·Ø§Ù‡Ø§ÛŒ ÙØ±Ù… Ø±Ø§ Ø¨Ø±Ø·Ø±Ù Ú©Ù†ÛŒØ¯.";
          return;
        }

        formMessage.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾Ø±Ø¯Ø§Ø®Øª...";
        const btn = paymentForm.querySelector('button[type="submit"]');
        btn.disabled = true;

        setTimeout(() => {
          const success = fields.number.value.startsWith("4"); // Ù†Ù…ÙˆÙ†Ù‡ ØªØ³ØªÛŒ
          if (success) {
            formMessage.textContent = "âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯. Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªÙ‚Ø§Ù„...";
            setTimeout(() => {
              hideModal();
              window.location.href = "confirmation.html";
            }, 1000);
          } else {
            formMessage.textContent = "âŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.";
            btn.disabled = false;
          }
        }, 1200);
      });

      // ---------------------------
      // ğŸ“¦ Û¶. Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ
      // ---------------------------
      document
        .getElementById("placeOrderBtn")
        .addEventListener("click", (e) => {
          e.preventDefault();
          const user = getUserFormValues();
          const valid = validateUserInfo(user);
          if (!valid) return;

          const payment = document.querySelector(
            'input[name="payment"]:checked'
          );
          if (!payment) return alert("Ù„Ø·ÙØ§Ù‹ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");

          localStorage.setItem(
            "checkoutUserInfo",
            JSON.stringify({ ...user, payment: payment.value })
          );
          payment.value === "online"
            ? showModal()
            : (window.location.href = "confirmation.html");
        });
    </script>
  </body>
</html>
